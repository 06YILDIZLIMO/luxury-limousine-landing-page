import VoiceResponse from 'twilio/lib/twiml/VoiceResponse';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  const formData = await request.formData();
  const speechResult = formData.get('SpeechResult') as string;
  
  const voiceResponse = new VoiceResponse();
  
  let aiMessage = '';
  
  if (speechResult && speechResult.trim()) {
    // Basic keyword-based responses (without AI)
    const speech = speechResult.toLowerCase();
    
    if (speech.includes('book') || speech.includes('reservation') || speech.includes('reserve')) {
      aiMessage = "Thank you for your interest in booking. Please visit our website at www.06yildizlimo.com to book your ride online, or call our reservation line. An agent will call you back shortly. Goodbye.";
    } else if (speech.includes('price') || speech.includes('cost') || speech.includes('how much')) {
      aiMessage = "Our luxury sedan service from Peterborough to Toronto airport starts at $350 plus HST. For a luxury SUV, it's $430 plus HST. Visit www.06yildizlimo.com for all pricing details. Thank you for calling.";
    } else if (speech.includes('airport') || speech.includes('yyz') || speech.includes('toronto')) {
      aiMessage = "We provide premium airport transfer services from Peterborough to Toronto Pearson airport. Our professional chauffeurs ensure a comfortable ride. Please visit our website or call for booking. Thank you.";
    } else if (speech.includes('wedding') || speech.includes('party') || speech.includes('event')) {
      aiMessage = "We offer luxury wedding and event services. Please visit www.06yildizlimo.com to see our fleet including Rolls-Royce, Mercedes S-Class, and party buses. Thank you for calling.";
    } else if (speech.includes('thank') || speech.includes('bye') || speech.includes('goodbye')) {
      aiMessage = "Thank you for calling Oh Six Yildiz Limo. We look forward to serving you. Goodbye!";
    } else {
      aiMessage = "Thank you for calling Oh Six Yildiz Limo. For reservations and pricing, please visit www.06yildizlimo.com or call our team. An agent will call you back shortly. Goodbye.";
    }
  } else {
    aiMessage = "Welcome to Oh Six Yildiz Limo. Your premium transportation service. For reservations, please visit our website at www.06yildizlimo.com or call our team.";
  }
  
  voiceResponse.say({
    voice: 'Polly.Amy-Neural',
    language: 'en-US'
  }, aiMessage);
  
  voiceResponse.say({
    voice: 'Polly.Amy-Neural',
  }, "Thank you for calling Oh Six Yildiz Limo. Goodbye.");
  
  const twiml = voiceResponse.toString();
  
  return new NextResponse(twiml, {
    headers: { 'Content-Type': 'text/xml' },
  });
}

export async function GET() {
  const voiceResponse = new VoiceResponse();
  
  voiceResponse.say({
    voice: 'Polly.Amy-Neural',
    language: 'en-US'
  }, "Welcome to Oh Six Yildiz Limo. Your premium transportation service. For reservations, please visit our website.");
  
  voiceResponse.gather({
    input: 'speech' as any,
    action: '/api/twilio/voice',
    method: 'POST',
    timeout: 5,
    speechTimeout: 'auto',
    language: 'en-US',
  } as any);
  
  const twiml = voiceResponse.toString();
  
  return new NextResponse(twiml, {
    headers: { 'Content-Type': 'text/xml' },
  });
}
