import { NextRequest, NextResponse } from 'next/server'

const TWILIO_ACCOUNT_SID = process.env.TWILIO_ACCOUNT_SID
const TWILIO_AUTH_TOKEN = process.env.TWILIO_AUTH_TOKEN
const TWILIO_PHONE_NUMBER = process.env.TWILIO_PHONE_NUMBER

export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData()
    const from = formData.get('From') as string
    const to = formData.get('To') as string
    const speechResult = formData.get('SpeechResult') as string
    const digits = formData.get('Digits') as string

    console.log(`Voice API - From: ${from}, To: ${to}`)
    console.log(`Speech: ${speechResult}, Digits: ${digits}`)

    // Generate AI response message
    let aiMessage: string

    if (!from) {
      // Initial call - greeting
      aiMessage = getGreetingMessage()
    } else if (speechResult || digits) {
      // User input - generate contextual response
      aiMessage = generateAIResponse(speechResult || digits)
    } else {
      // No input received
      aiMessage = "I didn't catch that. Could you please repeat?"
    }

    // Generate TwiML with AI voice (NO transfer - AI handles everything)
    const twiml = `<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say voice="Polly.Joanna" language="en-US" rate="1.0">
    ${aiMessage}
  </Say>
  <Gather input="dtmf speech" timeout="5" speechTimeout="auto" numDigits="1">
    <Say voice="Polly.Joanna" language="en-US">
      Say booking, pricing, fleet, or agent for help.
    </Say>
  </Gather>
</Response>`

    return new NextResponse(twiml, {
      headers: { 'Content-Type': 'text/xml' },
    })
  } catch (error) {
    console.error('Voice API error:', error)
    const errorTwiml = `<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Say voice="Polly.Joanna">I apologize, please try again later.</Say>
</Response>`
    return new NextResponse(errorTwiml, { headers: { 'Content-Type': 'text/xml' } })
  }
}

function getGreetingMessage(): string {
  const hour = new Date().getHours()
  if (hour < 12) return "Good morning! Welcome to Yildiz Limousine. I'm your AI assistant. How may I help you?"
  if (hour < 17) return "Good afternoon! Welcome to Yildiz Limousine. How can I assist you today?"
  return "Good evening! Thank you for calling Yildiz Limousine. How may I help you?"
}

function generateAIResponse(input: string): string {
  const normalizedInput = input.toLowerCase().trim()
  
  if (normalizedInput.includes('agent') || normalizedInput === '9') {
    return "I understand you'd like to speak with a live agent. Please call us at +1 (705) 991-1905 for immediate assistance. Is there anything else I can help you with?"
  }
  
  if (normalizedInput.includes('book') || normalizedInput === '1') {
    return "I'd be happy to help you book. Please provide your name, date, time, pickup location, and destination. We'll confirm your reservation within 24 hours."
  }
  
  if (normalizedInput.includes('price') || normalizedInput.includes('cost') || normalizedInput === '2') {
    return "Our luxury sedans start at $75, premium SUVs from $150, and stretch limousines from $250 per hour. Would you like a detailed quote?"
  }
  
  if (normalizedInput.includes('fleet') || normalizedInput.includes('vehicle') || normalizedInput === '3') {
    return "Our fleet includes Mercedes-Benz S-Class, BMW 7 Series, Cadillac Escalade, Lincoln Navigator, and Rolls Royce Phantom. Which interests you most?"
  }
  
  if (normalizedInput.includes('available') || normalizedInput.includes('when')) {
    return "We operate 24 hours a day, 7 days a week. What date and time do you need?"
  }
  
  if (normalizedInput.includes('thank') || normalizedInput.includes('bye')) {
    return "Thank you for choosing Yildiz Limousine! Have a wonderful day. Goodbye!"
  }
  
  return "I can help with booking, pricing, fleet information, or general questions. How may I assist you?"
}

export async function GET() {
  return NextResponse.json({
    status: 'ok',
    message: 'Twilio Voice AI - Calls handled by AI directly',
    mode: 'ai-voice-assistant'
  })
}
